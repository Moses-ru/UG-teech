<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–û–±—É—á–µ–Ω–∏–µ –Æ–∂–∞–Ω–µ</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
--primary: #722F37;
--primary-light: #9e4650;
--bg-color: #f8f9fa;
--card-bg: #ffffff;
--text-main: #2c3e50;
--text-sec: #7f8c8d;
--shadow: 0 4px 20px rgba(0,0,0,0.1);
--radius: 16px;
--transition: all 0.3s ease;
--header-height: 60px;
--nav-height: 70px;
--gold: #D4AF37;
--gold-light: #F4D06F;
}
[data-theme="dark"] {
--bg-color: #121212;
--card-bg: #1e1e1e;
--text-main: #ecf0f1;
--text-sec: #bdc3c7;
--shadow: 0 4px 20px rgba(0,0,0,0.3);
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }

html, body { 
    width: 100%; 
    height: 100%; 
    overflow: hidden;
}

body { 
    background-color: var(--bg-color); 
    color: var(--text-main); 
    transition: var(--transition); 
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
}

/* ========== –ö–†–ê–°–ò–í–´–ô –°–ï–†–¢–ò–§–ò–ö–ê–¢ ========== */
.certificate-container {
    perspective: 1000px;
    margin-bottom: 20px;
}

.certificate {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
    border-radius: var(--radius);
    padding: 40px 30px;
    text-align: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    border: 3px solid var(--gold);
    animation: certificateSlideIn 0.6s ease-out;
}

@keyframes certificateSlideIn {
    from {
        opacity: 0;
        transform: translateY(30px) rotateX(10deg);
    }
    to {
        opacity: 1;
        transform: translateY(0) rotateX(0);
    }
}

/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Ä–∞–º–∫–∞ */
.certificate::before {
    content: '';
    position: absolute;
    top: 10px; left: 10px; right: 10px; bottom: 10px;
    border: 2px solid var(--gold);
    border-radius: 12px;
    pointer-events: none;
}

.certificate::after {
    content: '';
    position: absolute;
    top: 15px; left: 15px; right: 15px; bottom: 15px;
    border: 1px dashed var(--gold-light);
    border-radius: 10px;
    pointer-events: none;
}

/* –£–≥–æ–ª–∫–∏ */
.certificate-corner {
    position: absolute;
    width: 60px;
    height: 60px;
    border: 3px solid var(--gold);
    pointer-events: none;
}

.certificate-corner.top-left {
    top: 10px; left: 10px;
    border-right: none; border-bottom: none;
}

.certificate-corner.top-right {
    top: 10px; right: 10px;
    border-left: none; border-bottom: none;
}

.certificate-corner.bottom-left {
    bottom: 10px; left: 10px;
    border-right: none; border-top: none;
}

.certificate-corner.bottom-right {
    bottom: 10px; right: 10px;
    border-left: none; border-top: none;
}

/* –ë–ª–µ—Å—Ç—è—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç */
.certificate-shine {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(212, 175, 55, 0.1) 45%,
        rgba(212, 175, 55, 0.2) 50%,
        rgba(212, 175, 55, 0.1) 55%,
        transparent 60%
    );
    animation: shine 3s infinite;
    pointer-events: none;
}

@keyframes shine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

/* –ò–∫–æ–Ω–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ */
.certificate-icon {
    font-size: 4rem;
    color: var(--gold);
    margin-bottom: 20px;
    animation: pulse 2s infinite;
    position: relative;
    z-index: 2;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.certificate-title {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--gold);
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 2px;
    position: relative;
    z-index: 2;
    text-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
}

.certificate-subtitle {
    font-size: 1rem;
    color: var(--gold-light);
    margin-bottom: 25px;
    position: relative;
    z-index: 2;
}

.certificate-recipient {
    font-size: 1.4rem;
    color: white;
    font-weight: 700;
    margin-bottom: 20px;
    padding: 15px 30px;
    background: rgba(212, 175, 55, 0.1);
    border-radius: 8px;
    border: 1px solid var(--gold);
    position: relative;
    z-index: 2;
}

.certificate-details {
    color: rgba(255,255,255,0.8);
    font-size: 0.95rem;
    line-height: 1.8;
    margin-bottom: 25px;
    position: relative;
    z-index: 2;
}

.certificate-date {
    color: var(--gold-light);
    font-size: 0.9rem;
    margin-bottom: 20px;
    position: relative;
    z-index: 2;
}

.certificate-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 25px;
    position: relative;
    z-index: 2;
}

.certificate-stat {
    background: rgba(212, 175, 55, 0.1);
    padding: 12px 8px;
    border-radius: 8px;
    border: 1px solid var(--gold);
}

.certificate-stat-value {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--gold);
}

.certificate-stat-label {
    font-size: 0.7rem;
    color: var(--gold-light);
    margin-top: 4px;
}

.certificate-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 20px;
    border-top: 1px solid rgba(212, 175, 55, 0.3);
    position: relative;
    z-index: 2;
}

.certificate-signature {
    text-align: left;
}

.certificate-signature-line {
    width: 120px;
    height: 2px;
    background: var(--gold);
    margin-bottom: 8px;
}

.certificate-signature-text {
    font-size: 0.8rem;
    color: var(--gold-light);
}

.certificate-seal {
    width: 60px;
    height: 60px;
    border: 3px solid var(--gold);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--gold);
    background: rgba(212, 175, 55, 0.1);
    animation: rotate 10s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
.certificate-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    position: relative;
    z-index: 2;
}

.certificate-btn {
    flex: 1;
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.certificate-btn-primary {
    background: linear-gradient(135deg, var(--gold), var(--gold-light));
    color: #1a1a2e;
}

.certificate-btn-secondary {
    background: rgba(255,255,255,0.1);
    color: white;
    border: 1px solid var(--gold);
}

.certificate-btn:active {
    transform: scale(0.95);
}

/* –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ */
.confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background: var(--gold);
    animation: confettiFall 3s linear forwards;
    pointer-events: none;
    z-index: 3000;
}

@keyframes confettiFall {
    0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
    }
    100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
    }
}

/* ========== –û–°–¢–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò ========== */
header {
position: fixed; top: 0; left: 0; right: 0;
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);
z-index: 1000;
padding: 12px 16px;
display: flex; justify-content: space-between; align-items: center;
border-bottom: 1px solid rgba(0,0,0,0.05);
height: var(--header-height);
}
[data-theme="dark"] header { background: rgba(30, 30, 30, 0.95); border-bottom: 1px solid rgba(255,255,255,0.05); }
.logo { font-size: 1.2rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
.header-actions { display: flex; gap: 10px; align-items: center; }
.btn-theme {
width: 36px; height: 36px;
border-radius: 10px;
background: var(--card-bg);
border: 1px solid rgba(0,0,0,0.1);
color: var(--text-main);
display: flex; align-items: center; justify-content: center;
cursor: pointer;
transition: var(--transition);
}
.btn-theme:active { transform: scale(0.95); }

.main-container {
padding: calc(var(--header-height) + 16px) 16px 16px;
height: 100vh;
overflow-y: auto;
overflow-x: hidden;
padding-bottom: calc(var(--nav-height) + 20px);
-webkit-overflow-scrolling: touch;
}

.progress-card {
background: var(--card-bg);
border-radius: var(--radius);
padding: 20px;
margin-bottom: 20px;
box-shadow: var(--shadow);
}
.progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.progress-title { font-size: 1.1rem; font-weight: 700; }
.progress-percent { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
.progress-bar-bg { height: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; margin-bottom: 12px; }
.progress-bar-fill { height: 100%; border-radius: 6px; background: linear-gradient(90deg, var(--primary), var(--primary-light)); transition: width 0.8s ease-out; }
.progress-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.stat-box { text-align: center; padding: 8px; background: var(--bg-color); border-radius: 8px; }
.stat-value { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
.stat-label { font-size: 0.7rem; color: var(--text-sec); }

.section-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
.chapters-grid { display: grid; gap: 12px; margin-bottom: 24px; }
.chapter-card {
background: var(--card-bg);
border-radius: var(--radius);
padding: 16px;
display: flex;
gap: 16px;
align-items: center;
cursor: pointer;
transition: var(--transition);
box-shadow: var(--shadow);
}
.chapter-card:active { transform: scale(0.98); }
.chapter-card.locked { opacity: 0.6; pointer-events: none; }
.chapter-card.completed { border: 2px solid #27ae60; }
.chapter-card.current { border: 2px solid var(--primary); }
.chapter-icon {
width: 50px; height: 50px;
border-radius: 12px;
background: var(--primary);
color: white;
display: flex; align-items: center; justify-content: center;
font-size: 1.5rem;
flex-shrink: 0;
}
.chapter-info { flex: 1; }
.chapter-title { font-size: 1rem; font-weight: 700; margin-bottom: 4px; }
.chapter-desc { font-size: 0.85rem; color: var(--text-sec); }
.chapter-status {
padding: 4px 12px;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 600;
}
.status-lock { background: rgba(0,0,0,0.1); color: var(--text-sec); }
.status-current { background: var(--primary); color: white; }
.status-done { background: #27ae60; color: white; }

.lesson-view {
position: fixed;
top: 0; left: 0; width: 100%; height: 100%;
background: var(--bg-color);
z-index: 1001;
transform: translateX(100%);
transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
overflow-y: auto;
-webkit-overflow-scrolling: touch;
}
.lesson-view.active { transform: translateX(0); }
.lesson-header {
position: sticky; top: 0;
background: var(--card-bg);
padding: 16px;
display: flex; justify-content: space-between; align-items: center;
border-bottom: 1px solid rgba(0,0,0,0.05);
z-index: 10;
}
[data-theme="dark"] .lesson-header { border-bottom: 1px solid rgba(255,255,255,0.05); }
.lesson-back {
width: 40px; height: 40px;
border-radius: 50%;
background: rgba(0,0,0,0.05);
border: none;
color: var(--text-main);
font-size: 1.2rem;
cursor: pointer;
display: flex; align-items: center; justify-content: center;
}
.lesson-content { padding: 20px; padding-bottom: 100px; }
.lesson-image {
width: 100%;
border-radius: var(--radius);
margin-bottom: 20px;
object-fit: cover;
max-height: 300px;
}
.lesson-text { font-size: 1rem; line-height: 1.8; color: var(--text-main); margin-bottom: 24px; white-space: pre-line; }
.lesson-nav { display: flex; gap: 12px; margin-top: 30px; }
.lesson-btn {
flex: 1;
padding: 14px;
border-radius: 12px;
border: none;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: var(--transition);
}
.btn-primary { background: var(--primary); color: white; }
.btn-secondary { background: var(--bg-color); color: var(--text-main); border: 1px solid rgba(0,0,0,0.1); }
.lesson-btn:active { transform: scale(0.98); }

.test-view {
position: fixed;
top: 0; left: 0; width: 100%; height: 100%;
background: var(--bg-color);
z-index: 1002;
transform: translateX(100%);
transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
overflow-y: auto;
-webkit-overflow-scrolling: touch;
}
.test-view.active { transform: translateX(0); }
.test-progress { padding: 16px; background: var(--card-bg); border-bottom: 1px solid rgba(0,0,0,0.05); }
.test-question { padding: 20px; font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; }
.test-options { display: grid; gap: 12px; }
.test-option {
padding: 16px;
background: var(--card-bg);
border-radius: 12px;
border: 2px solid transparent;
cursor: pointer;
transition: var(--transition);
text-align: left;
}
.test-option:active { transform: scale(0.98); }
.test-option.selected { border-color: var(--primary); background: rgba(114, 47, 55, 0.1); }
.test-option.correct { border-color: #27ae60; background: rgba(39, 174, 96, 0.1); }
.test-option.wrong { border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }
.test-feedback {
padding: 16px;
margin-top: 16px;
border-radius: 12px;
background: rgba(114, 47, 55, 0.05);
display: none;
}
.test-feedback.show { display: block; }

.references-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
.ref-card {
background: var(--card-bg);
border-radius: var(--radius);
padding: 20px 16px;
text-align: center;
cursor: pointer;
transition: var(--transition);
box-shadow: var(--shadow);
}
.ref-card:active { transform: scale(0.95); }
.ref-icon { font-size: 2rem; margin-bottom: 8px; }
.ref-title { font-size: 0.9rem; font-weight: 600; }
.search-box {
width: 100%;
padding: 12px 16px;
border-radius: 12px;
border: 1px solid rgba(0,0,0,0.1);
background: var(--card-bg);
color: var(--text-main);
font-size: 1rem;
margin-bottom: 16px;
}
[data-theme="dark"] .search-box { border-color: rgba(255,255,255,0.1); }
.ref-results { display: grid; gap: 12px; }
.ref-item {
background: var(--card-bg);
border-radius: 12px;
padding: 16px;
box-shadow: var(--shadow);
}
.ref-item-key { font-weight: 700; color: var(--primary); margin-bottom: 8px; }
.ref-item-value { font-size: 0.95rem; line-height: 1.6; }

.bottom-nav {
position: fixed;
bottom: 0; left: 0; right: 0;
background: var(--card-bg);
border-top: 1px solid rgba(0,0,0,0.05);
display: flex;
justify-content: space-around;
padding: 8px 0;
z-index: 1000;
}
[data-theme="dark"] .bottom-nav { border-top: 1px solid rgba(255,255,255,0.05); }
.nav-item {
display: flex;
flex-direction: column;
align-items: center;
gap: 4px;
padding: 8px 16px;
color: var(--text-sec);
cursor: pointer;
transition: var(--transition);
border-radius: 12px;
}
.nav-item.active { color: var(--primary); }
.nav-item:active { transform: scale(0.95); }
.nav-icon { font-size: 1.3rem; }
.nav-label { font-size: 0.75rem; font-weight: 500; }

.loading {
position: fixed;
top: 0; left: 0; width: 100%; height: 100%;
background: var(--bg-color);
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
z-index: 2000;
transition: opacity 0.5s ease;
}
.loading.hidden { opacity: 0; pointer-events: none; }
.loading-icon { font-size: 3rem; color: var(--primary); margin-bottom: 20px; animation: pulse 1.5s infinite; }
.loading-text { font-size: 1.1rem; color: var(--text-sec); }
.loading-error { 
font-size: 0.9rem; 
color: #e74c3c; 
margin-top: 20px; 
text-align: center;
max-width: 80%;
}
.loading-error button {
margin-top: 15px;
padding: 10px 20px;
background: var(--primary);
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
}
@keyframes pulse {
0%, 100% { transform: scale(1); opacity: 1; }
50% { transform: scale(1.1); opacity: 0.7; }
}

.screen { display: none; }
.screen.active { display: block; }

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 2px; }
[data-theme="dark"] ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }
</style>
</head>
<body data-theme="dark">

<div class="loading" id="loading">
<div class="loading-icon"><i class="fas fa-graduation-cap"></i></div>
<div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—É—á–µ–Ω–∏—è...</div>
<div class="loading-error" id="loadingError"></div>
</div>

<header>
<div class="logo">
<i class="fas fa-utensils"></i>
<span>–Æ–∂–∞–Ω–µ –û–±—É—á–µ–Ω–∏–µ</span>
</div>
<div class="header-actions">
<button class="btn-theme" id="themeToggle">
<i class="fas fa-sun"></i>
</button>
</div>
</header>

<div class="main-container">
<div class="screen active" id="homeScreen">
<div class="progress-card">
<div class="progress-header">
<span class="progress-title">–¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</span>
<span class="progress-percent" id="progressPercent">0%</span>
</div>
<div class="progress-bar-bg">
<div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
</div>
<div class="progress-stats">
<div class="stat-box">
<div class="stat-value" id="statCompleted">0</div>
<div class="stat-label">–ü—Ä–æ–π–¥–µ–Ω–æ</div>
</div>
<div class="stat-box">
<div class="stat-value" id="statTotal">4</div>
<div class="stat-label">–ë–ª–æ–∫–æ–≤</div>
</div>
<div class="stat-box">
<div class="stat-value" id="statTests">0</div>
<div class="stat-label">–¢–µ—Å—Ç–æ–≤</div>
</div>
<div class="stat-box">
<div class="stat-value" id="statScore">0%</div>
<div class="stat-label">–°—Ä–µ–¥–Ω–∏–π</div>
</div>
</div>
</div>

<div class="section-title">
<i class="fas fa-book"></i>
–ë–ª–æ–∫–∏ –æ–±—É—á–µ–Ω–∏—è
</div>
<div class="chapters-grid" id="chaptersGrid"></div>

<div class="section-title">
<i class="fas fa-graduation-cap"></i>
–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
</div>
<div id="certificateContainer"></div>
</div>

<div class="screen" id="referencesScreen">
<div class="section-title">
<i class="fas fa-search"></i>
–ü–æ–∏—Å–∫ –ø–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º
</div>
<input type="text" class="search-box" id="refSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞...">

<div class="references-grid">
<div class="ref-card" data-type="menu">
<div class="ref-icon">üçΩÔ∏è</div>
<div class="ref-title">–ú–µ–Ω—é</div>
</div>
<div class="ref-card" data-type="wine">
<div class="ref-icon">üç∑</div>
<div class="ref-title">–í–∏–Ω–æ</div>
</div>
<div class="ref-card" data-type="allergens">
<div class="ref-icon">‚ö†Ô∏è</div>
<div class="ref-title">–ê–ª–ª–µ—Ä–≥–µ–Ω—ã</div>
</div>
</div>

<div class="section-title" id="refResultsTitle">
<i class="fas fa-list"></i>
–†–µ–∑—É–ª—å—Ç–∞—Ç—ã
</div>
<div class="ref-results" id="refResults"></div>
</div>

<div class="screen" id="profileScreen">
<div class="progress-card">
<div class="progress-header">
<span class="progress-title">–ü—Ä–æ—Ñ–∏–ª—å</span>
</div>
<div style="text-align: center; padding: 20px;">
<div style="width: 80px; height: 80px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 2rem; color: white;">
<i class="fas fa-user"></i>
</div>
<div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 8px;" id="profileName">–ì–æ—Å—Ç—å</div>
<div style="color: var(--text-sec); margin-bottom: 20px;" id="profileId">ID: ---</div>
<button class="lesson-btn btn-secondary" id="resetProgress" style="width: 100%;">
<i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
</button>
</div>
</div>

<div class="section-title">
<i class="fas fa-chart-bar"></i>
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±–ª–æ–∫–∞–º
</div>
<div id="blockStats" style="display: grid; gap: 12px;"></div>
</div>
</div>

<div class="lesson-view" id="lessonView">
<div class="lesson-header">
<button class="lesson-back" id="lessonBack">
<i class="fas fa-arrow-left"></i>
</button>
<div style="font-weight: 600;" id="lessonTitle">–ë–ª–æ–∫ 1</div>
<div style="width: 40px;"></div>
</div>
<div class="lesson-content" id="lessonContent"></div>
</div>

<div class="test-view" id="testView">
<div class="lesson-header">
<button class="lesson-back" id="testBack">
<i class="fas fa-arrow-left"></i>
</button>
<div style="font-weight: 600;">–¢–µ—Å—Ç</div>
<div style="font-size: 0.9rem; color: var(--text-sec);" id="testProgress">1/10</div>
</div>
<div class="test-progress">
<div class="progress-bar-bg" style="height: 6px;">
<div class="progress-bar-fill" id="testProgressBar" style="width: 0%"></div>
</div>
</div>
<div class="lesson-content">
<div class="test-question" id="testQuestion">–í–æ–ø—Ä–æ—Å...</div>
<div class="test-options" id="testOptions"></div>
<div class="test-feedback" id="testFeedback">
<div style="font-weight: 600; margin-bottom: 8px;" id="feedbackTitle"></div>
<div id="feedbackText"></div>
</div>
<button class="lesson-btn btn-primary" id="testNext" style="width: 100%; margin-top: 20px; display: none;">
–î–∞–ª—å—à–µ <i class="fas fa-arrow-right"></i>
</button>
</div>
</div>

<div class="bottom-nav">
<div class="nav-item active" data-screen="homeScreen">
<div class="nav-icon"><i class="fas fa-home"></i></div>
<div class="nav-label">–ì–ª–∞–≤–Ω–∞—è</div>
</div>
<div class="nav-item" data-screen="referencesScreen">
<div class="nav-icon"><i class="fas fa-book"></i></div>
<div class="nav-label">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</div>
</div>
<div class="nav-item" data-screen="profileScreen">
<div class="nav-icon"><i class="fas fa-user"></i></div>
<div class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const SHEET_ID = '158E5Bv70FryY6MFPADvtXAaDgndIvzWgCkTXC8IhmnQ';
const GVIZ_URL = 'https://docs.google.com/spreadsheets/d/{sheet_id}/gviz/tq?tqx=out:csv&sheet={sheet_name}';

const FALLBACK_DATA = {
    texts: {
        1: [{ text: "üè† –°–ï–ú–¨–Ø –Æ–ñ–ê–ù\n\n18+ ‚Äî —ç—Ç–æ —ç—Ç–∞–ª–æ–Ω —Ö–∏–Ω–∫–∞–ª–∏ —Å 18 —Å–∫–ª–∞–¥–∫–∞–º–∏.", image: "" }],
        2: [{ text: "ü§ù –°–ï–†–í–ò–°\n\n–ì–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ –ø—Ä–∞–≤.", image: "" }],
        3: [{ text: "üç≥ –ö–£–•–ù–Ø\n\n–•–∏–Ω–∫–∞–ª–∏ –µ–¥—è—Ç —Ä—É–∫–∞–º–∏.", image: "" }],
        4: [{ text: "üç∑ –ë–ê–† –ò –í–ò–ù–û\n\n–í–∏–Ω–æ –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ–¥ –±–ª—é–¥–æ.", image: "" }]
    },
    questions: {
        1: [{ question: "–ü–æ—á–µ–º—É 18+?", options: ["–¶–µ–Ω–∑—É—Ä–∞", "–≠—Ç–∞–ª–æ–Ω —Ö–∏–Ω–∫–∞–ª–∏", "–ß–∏—Å–ª–æ"], correct: 1, explanation: "18 —Å–∫–ª–∞–¥–æ–∫" }],
        2: [{ question: "–ì–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ –ø—Ä–∞–≤?", options: ["–î–∞", "–ù–µ—Ç"], correct: 0, explanation: "–î–∞!" }],
        3: [{ question: "–ß–µ–º –µ–¥—è—Ç —Ö–∏–Ω–∫–∞–ª–∏?", options: ["–í–∏–ª–∫–æ–π", "–†—É–∫–∞–º–∏"], correct: 1, explanation: "–†—É–∫–∞–º–∏!" }],
        4: [{ question: "–ö–∞–∫ –ø–æ–¥–±–∏—Ä–∞—é—Ç –≤–∏–Ω–æ?", options: ["–ü–æ–¥ –±–ª—é–¥–æ", "–°–ª—É—á–∞–π–Ω–æ"], correct: 0, explanation: "–ü–æ–¥ –±–ª—é–¥–æ!" }]
    },
    menu: { "—Ö–∏–Ω–∫–∞–ª–∏": "ü•ü 18 —Å–∫–ª–∞–¥–æ–∫", "—Ö–∞—á–∞–ø—É—Ä–∏": "üßÄ –°—ã—Ä" },
    wine: { "—Å—Ç–µ–π–∫": "üç∑ –ö—Ä–∞—Å–Ω–æ–µ", "—Ä—ã–±–∞": "ü•Ç –ë–µ–ª–æ–µ" },
    allergens: { "–æ—Ä–µ—Ö–∏": "‚ö†Ô∏è –û—Ä–µ—Ö–∏", "–≥–ª—é—Ç–µ–Ω": "‚ö†Ô∏è –ì–ª—é—Ç–µ–Ω" }
};

let appData = { texts: {}, questions: {}, menu: {}, wine: {}, allergens: {} };
let userProgress = {
    currentBlock: 1, currentStep: 'text', textIndex: 0,
    testScores: {}, passedBlocks: [], blocksLocked: {}, testHistory: {}
};
let currentLesson = { block: 1, index: 0 };
let currentTest = { block: 1, questionIndex: 0, answers: [] };
let currentRefType = 'menu';
let isLoading = false;

// ========== –§–£–ù–ö–¶–ò–Ø –ö–†–ê–°–ò–í–û–ì–û –°–ï–†–¢–ò–§–ò–ö–ê–¢–ê ==========
function generateCertificate() {
    const user = tg.initDataUnsafe?.user;
    const userName = user ? (user.first_name + (user.last_name ? ' ' + user.last_name : '')) : '–Æ–∂–∞–Ω–∏–Ω';
    const today = new Date().toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });
    
    const totalScore = Object.values(userProgress.testScores).reduce((a, b) => a + b, 0);
    const avgScore = userProgress.passedBlocks.length > 0 ? Math.round(totalScore / userProgress.passedBlocks.length) : 0;
    
    return `
    <div class="certificate-container">
        <div class="certificate">
            <div class="certificate-shine"></div>
            <div class="certificate-corner top-left"></div>
            <div class="certificate-corner top-right"></div>
            <div class="certificate-corner bottom-left"></div>
            <div class="certificate-corner bottom-right"></div>
            
            <div class="certificate-icon">
                <i class="fas fa-trophy"></i>
            </div>
            
            <div class="certificate-title">–°–ï–†–¢–ò–§–ò–ö–ê–¢</div>
            <div class="certificate-subtitle">–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è</div>
            
            <div class="certificate-recipient">
                ${userName}
            </div>
            
            <div class="certificate-details">
                –ü—Ä–æ—à—ë–ª –≤—Å–µ 4 –±–ª–æ–∫–∞ –æ–±—É—á–µ–Ω–∏—è<br>
                –∏ —Å—Ç–∞–ª –Ω–∞—Å—Ç–æ—è—â–∏–º <strong>–Æ–ñ–ê–ù–ò–ù–û–ú</strong>
            </div>
            
            <div class="certificate-stats">
                <div class="certificate-stat">
                    <div class="certificate-stat-value">4</div>
                    <div class="certificate-stat-label">–ë–ª–æ–∫–∞</div>
                </div>
                <div class="certificate-stat">
                    <div class="certificate-stat-value">${userProgress.testScores['chapter_1'] || 0}</div>
                    <div class="certificate-stat-label">–ë–ª–æ–∫ 1</div>
                </div>
                <div class="certificate-stat">
                    <div class="certificate-stat-value">${userProgress.testScores['chapter_2'] || 0}</div>
                    <div class="certificate-stat-label">–ë–ª–æ–∫ 2</div>
                </div>
                <div class="certificate-stat">
                    <div class="certificate-stat-value">${avgScore}%</div>
                    <div class="certificate-stat-label">–°—Ä–µ–¥–Ω–∏–π</div>
                </div>
            </div>
            
            <div class="certificate-date">
                <i class="fas fa-calendar-alt"></i> –í—ã–¥–∞–Ω: ${today}
            </div>
            
            <div class="certificate-footer">
                <div class="certificate-signature">
                    <div class="certificate-signature-line"></div>
                    <div class="certificate-signature-text">–î–∞—Ç–æ, –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å</div>
                </div>
                <div class="certificate-seal">
                    <i class="fas fa-utensils"></i>
                </div>
            </div>
            
            <div class="certificate-actions">
                <button class="certificate-btn certificate-btn-primary" onclick="shareCertificate()">
                    <i class="fas fa-share-alt"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
                <button class="certificate-btn certificate-btn-secondary" onclick="downloadCertificate()">
                    <i class="fas fa-download"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
    `;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
function startConfetti() {
    const colors = ['#D4AF37', '#F4D06F', '#722F37', '#9e4650', '#ffffff'];
    for (let i = 0; i < 50; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 4000);
        }, i * 50);
    }
}

function shareCertificate() {
    const user = tg.initDataUnsafe?.user;
    const userName = user ? (user.first_name + (user.last_name ? ' ' + user.last_name : '')) : '–Æ–∂–∞–Ω–∏–Ω';
    tg.shareUrl('', `üèÜ –Ø —Å—Ç–∞–ª –Æ–ñ–ê–ù–ò–ù–û–ú! –ü—Ä–æ–π—Ç–∏ –æ–±—É—á–µ–Ω–∏–µ: ${window.location.href}`);
}

function downloadCertificate() {
    tg.showAlert('üì∏ –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞!');
}

// ========== –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î ==========
function parseCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentCell = '';
    let inQuotes = false;
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];
        
        if (inQuotes) {
            if (char === '"') {
                if (nextChar === '"') {
                    currentCell += '"';
                    i++;
                } else {
                    inQuotes = false;
                }
            } else {
                currentCell += char;
            }
        } else {
            if (char === '"') {
                inQuotes = true;
            } else if (char === ',') {
                currentRow.push(currentCell.trim());
                currentCell = '';
            } else if (char === '\n') {
                currentRow.push(currentCell.trim());
                if (currentRow.length > 0 && currentRow.some(c => c !== '')) {
                    rows.push(currentRow);
                }
                currentRow = [];
                currentCell = '';
            } else if (char !== '\r') {
                currentCell += char;
            }
        }
    }
    
    if (currentCell || currentRow.length > 0) {
        currentRow.push(currentCell.trim());
        if (currentRow.some(c => c !== '')) {
            rows.push(currentRow);
        }
    }
    
    if (rows.length < 2) return [];
    const headers = rows[0].map(h => h.toLowerCase().replace(/[^a-z0-9]/g, '_'));
    
    return rows.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => {
            obj[h] = row[i] || '';
        });
        return obj;
    });
}

async function fetchSheet(sheetName, timeout = 8000) {
    const url = GVIZ_URL.replace('{sheet_id}', SHEET_ID).replace('{sheet_name}', sheetName);
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    
    try {
        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(id);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const text = await response.text();
        return parseCSV(text);
    } catch (e) {
        console.warn(`Failed to load ${sheetName}:`, e.message);
        return null;
    }
}

async function loadAllData() {
    if (isLoading) return;
    isLoading = true;
    
    try {
        const [textsRows, questionsRows, menuRows, wineRows, allergensRows] = await Promise.all([
            fetchSheet('Texts'),
            fetchSheet('Questions'),
            fetchSheet('Menu'),
            fetchSheet('Wine'),
            fetchSheet('Allergens')
        ]);
        
        let loaded = false;
        
        if (textsRows && textsRows.length > 0) {
            loaded = true;
            textsRows.forEach(row => {
                const ch = parseInt(row.chapter) || 1;
                if (ch >= 1 && ch <= 4) {
                    if (!appData.texts[ch]) appData.texts[ch] = [];
                    appData.texts[ch].push({
                        text: row.text || '',
                        image: row.image || ''
                    });
                }
            });
        }
        
        if (questionsRows && questionsRows.length > 0) {
            loaded = true;
            questionsRows.forEach(row => {
                const ch = parseInt(row.chapter) || 1;
                if (ch >= 1 && ch <= 4) {
                    const options = [];
                    for (let i = 1; i <= 10; i++) {
                        const opt = row[`option_${i}`] || row[`option${i}`];
                        if (opt && opt.trim() !== '') options.push(opt);
                    }
                    
                    let correct = 0;
                    const correctRaw = row.correct;
                    if (correctRaw) {
                        const cr = String(correctRaw).trim();
                        if (cr >= 'A' && cr <= 'J') {
                            correct = cr.charCodeAt(0) - 65;
                        } else if (!isNaN(parseInt(cr))) {
                            correct = parseInt(cr);
                        }
                    }
                    
                    if (!appData.questions[ch]) appData.questions[ch] = [];
                    appData.questions[ch].push({
                        question: row.question || '',
                        options,
                        correct,
                        explanation: row.explanation || ''
                    });
                }
            });
        }
        
        if (menuRows && menuRows.length > 0) {
            loaded = true;
            menuRows.forEach(r => { 
                const key = (r.key || '').toLowerCase().trim();
                const val = r.value || '';
                if (key && val) appData.menu[key] = val; 
            });
        }
        if (wineRows && wineRows.length > 0) {
            loaded = true;
            wineRows.forEach(r => { 
                const key = (r.key || '').toLowerCase().trim();
                const val = r.value || '';
                if (key && val) appData.wine[key] = val; 
            });
        }
        if (allergensRows && allergensRows.length > 0) {
            loaded = true;
            allergensRows.forEach(r => { 
                const key = (r.key || '').toLowerCase().trim();
                const val = r.value || '';
                if (key && val) appData.allergens[key] = val; 
            });
        }
        
        console.log('üìä Data loaded:', {
            texts: Object.keys(appData.texts).map(k => `${k}:${appData.texts[k]?.length || 0}`),
            questions: Object.keys(appData.questions).map(k => `${k}:${appData.questions[k]?.length || 0}`),
            menu: Object.keys(appData.menu).length
        });
        
        if (!loaded) {
            throw new Error('No data loaded from sheets');
        }
        
        for (let ch = 1; ch <= 4; ch++) {
            if (!appData.texts[ch] || appData.texts[ch].length === 0) {
                appData.texts[ch] = FALLBACK_DATA.texts[ch] || [];
            }
            if (!appData.questions[ch] || appData.questions[ch].length === 0) {
                appData.questions[ch] = FALLBACK_DATA.questions[ch] || [];
            }
        }
        
    } catch (e) {
        console.error('Load error:', e);
        appData = JSON.parse(JSON.stringify(FALLBACK_DATA));
        document.getElementById('loadingError').innerHTML = `
            ‚ö†Ô∏è Google Sheets –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã<br>
            <button onclick="location.reload()">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        `;
    } finally {
        isLoading = false;
    }
}

function loadProgress() {
    const saved = localStorage.getItem('ujzhan_progress');
    if (saved) {
        userProgress = { ...userProgress, ...JSON.parse(saved) };
    }
    const user = tg.initDataUnsafe?.user;
    if (user) {
        document.getElementById('profileName').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
        document.getElementById('profileId').textContent = `ID: ${user.id}`;
    }
}

function saveProgress() {
    localStorage.setItem('ujzhan_progress', JSON.stringify(userProgress));
    
    if (tg && tg.sendData) {
        try {
            tg.sendData(JSON.stringify({
                type: 'progress_sync',
                currentBlock: userProgress.currentBlock,
                passedBlocks: userProgress.passedBlocks,
                testScores: userProgress.testScores,
                testHistory: userProgress.testHistory,
                timestamp: new Date().toISOString()
            }));
            console.log('üì§ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É');
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É:', e);
        }
    }
}

function getProgressPercent() {
    const passed = userProgress.passedBlocks.length;
    return Math.round((passed / 4) * 100);
}

function updateProgressUI() {
    const percent = getProgressPercent();
    document.getElementById('progressPercent').textContent = `${percent}%`;
    document.getElementById('progressBar').style.width = `${percent}%`;
    document.getElementById('statCompleted').textContent = userProgress.passedBlocks.length;
    document.getElementById('statTests').textContent = Object.keys(userProgress.testScores).length;
    
    const scores = Object.values(userProgress.testScores);
    const avgScore = scores.length ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
    document.getElementById('statScore').textContent = `${avgScore}%`;
    
    renderChapters();
    renderBlockStats();
}

function renderChapters() {
    const grid = document.getElementById('chaptersGrid');
    const chapters = [
        { num: 1, title: '–õ–µ–≥–µ–Ω–¥—ã –Æ–∂–∞–Ω', icon: 'üè†', desc: '–ò—Å—Ç–æ—Ä–∏—è –∏ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è' },
        { num: 2, title: '–°–µ—Ä–≤–∏—Å', icon: 'ü§ù', desc: '–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è' },
        { num: 3, title: '–ö—É—Ö–Ω—è', icon: 'üç≥', desc: '–ú–µ–Ω—é –∏ –±–ª—é–¥–∞' },
        { num: 4, title: '–ë–∞—Ä –∏ –≤–∏–Ω–æ', icon: 'üç∑', desc: '–í–∏–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞' }
    ];
    
    grid.innerHTML = chapters.map(ch => {
        const isPassed = userProgress.passedBlocks.includes(`chapter_${ch.num}`);
        const isLocked = ch.num > userProgress.currentBlock;
        const isCurrent = ch.num === userProgress.currentBlock;
        
        let statusClass = 'status-lock';
        let statusText = 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ';
        if (isPassed) { statusClass = 'status-done'; statusText = '‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ'; }
        else if (isCurrent) { statusClass = 'status-current'; statusText = 'üìñ –í –ø—Ä–æ—Ü–µ—Å—Å–µ'; }
        
        const cardClass = `chapter-card ${isLocked ? 'locked' : ''} ${isPassed ? 'completed' : ''} ${isCurrent ? 'current' : ''}`;
        
        return `
        <div class="${cardClass}" onclick="openChapter(${ch.num})">
            <div class="chapter-icon">${ch.icon}</div>
            <div class="chapter-info">
                <div class="chapter-title">–ë–ª–æ–∫ ${ch.num}: ${ch.title}</div>
                <div class="chapter-desc">${ch.desc}</div>
            </div>
            <div class="chapter-status ${statusClass}">${statusText}</div>
        </div>
        `;
    }).join('');
}

function renderBlockStats() {
    const container = document.getElementById('blockStats');
    const chapters = [
        { num: 1, title: '–õ–µ–≥–µ–Ω–¥—ã –Æ–∂–∞–Ω' },
        { num: 2, title: '–°–µ—Ä–≤–∏—Å' },
        { num: 3, title: '–ö—É—Ö–Ω—è' },
        { num: 4, title: '–ë–∞—Ä –∏ –≤–∏–Ω–æ' }
    ];
    
    container.innerHTML = chapters.map(ch => {
        const score = userProgress.testScores[`chapter_${ch.num}`] || 0;
        const total = appData.questions[ch.num]?.length || 0;
        const history = userProgress.testHistory[`chapter_${ch.num}`] || [];
        
        return `
        <div class="ref-item">
            <div class="ref-item-key">–ë–ª–æ–∫ ${ch.num}: ${ch.title}</div>
            <div class="ref-item-value">
                –†–µ–∑—É–ª—å—Ç–∞—Ç: ${score}/${total} (${Math.round((score/total)*100) || 0}%)<br>
                –ü–æ–ø—ã—Ç–æ–∫: ${history.length}
            </div>
        </div>
        `;
    }).join('');
}

function renderReferences(query = '') {
    const container = document.getElementById('refResults');
    const data = appData[currentRefType] || {};
    const entries = Object.entries(data).filter(([key]) => 
        !query || key.includes(query.toLowerCase())
    );
    
    if (entries.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-sec);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
    }
    
    container.innerHTML = entries.slice(0, 50).map(([key, value]) => `
    <div class="ref-item">
        <div class="ref-item-key">${key}</div>
        <div class="ref-item-value">${value}</div>
    </div>
    `).join('');
}

function switchScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
    document.querySelector(`.nav-item[data-screen="${screenId}"]`)?.classList.add('active');
}

document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => switchScreen(item.dataset.screen));
});

function openChapter(blockNum) {
    if (blockNum > userProgress.currentBlock) return;
    currentLesson = { block: blockNum, index: 0 };
    userProgress.currentBlock = blockNum;
    userProgress.currentStep = 'text';
    userProgress.textIndex = 0;
    saveProgress();
    showLesson();
}

function showLesson() {
    const view = document.getElementById('lessonView');
    const content = document.getElementById('lessonContent');
    const title = document.getElementById('lessonTitle');
    const texts = appData.texts[currentLesson.block] || [];
    const item = texts[currentLesson.index];
    
    if (!item) {
        startTest();
        return;
    }
    
    title.textContent = `–ë–ª–æ–∫ ${currentLesson.block} ‚Ä¢ ${currentLesson.index + 1}/${texts.length}`;
    
    let html = '';
    if (item.image && item.image.startsWith('http')) {
        html += `<img src="${item.image}" class="lesson-image" alt="Lesson image">`;
    }
    html += `<div class="lesson-text">${item.text}</div>`;
    
    const isLast = currentLesson.index >= texts.length - 1;
    html += `
    <div class="lesson-nav">
        ${currentLesson.index > 0 ? '<button class="lesson-btn btn-secondary" onclick="prevLesson()">‚Üê –ù–∞–∑–∞–¥</button>' : ''}
        <button class="lesson-btn btn-primary" onclick="${isLast ? 'startTest()' : 'nextLesson()'}">
            ${isLast ? 'üìã –ö —Ç–µ—Å—Ç—É' : '–î–∞–ª—å—à–µ ‚Üí'}
        </button>
    </div>
    `;
    
    content.innerHTML = html;
    view.classList.add('active');
}

function nextLesson() {
    currentLesson.index++;
    userProgress.textIndex = currentLesson.index;
    saveProgress();
    showLesson();
}

function prevLesson() {
    if (currentLesson.index > 0) {
        currentLesson.index--;
        userProgress.textIndex = currentLesson.index;
        saveProgress();
        showLesson();
    }
}

document.getElementById('lessonBack').addEventListener('click', () => {
    document.getElementById('lessonView').classList.remove('active');
});

function startTest() {
    currentTest = { block: currentLesson.block, questionIndex: 0, answers: [] };
    showTestQuestion();
    document.getElementById('lessonView').classList.remove('active');
    document.getElementById('testView').classList.add('active');
}

function showTestQuestion() {
    const questions = appData.questions[currentTest.block] || [];
    if (currentTest.questionIndex >= questions.length) {
        finishTest();
        return;
    }
    
    const q = questions[currentTest.questionIndex];
    const progress = ((currentTest.questionIndex) / questions.length) * 100;
    
    document.getElementById('testProgress').textContent = `${currentTest.questionIndex + 1}/${questions.length}`;
    document.getElementById('testProgressBar').style.width = `${progress}%`;
    document.getElementById('testQuestion').textContent = `‚ùì ${q.question}`;
    
    const optionsHtml = q.options.map((opt, i) => `
    <div class="test-option" onclick="selectAnswer(${i})">
        ${String.fromCharCode(65 + i)}) ${opt}
    </div>
    `).join('');
    
    document.getElementById('testOptions').innerHTML = optionsHtml;
    document.getElementById('testFeedback').classList.remove('show');
    document.getElementById('testNext').style.display = 'none';
}

function selectAnswer(index) {
    const questions = appData.questions[currentTest.block] || [];
    const q = questions[currentTest.questionIndex];
    const options = document.querySelectorAll('.test-option');
    
    options.forEach((opt, i) => {
        opt.classList.remove('selected', 'correct', 'wrong');
        if (i === index) opt.classList.add('selected');
        if (i === q.correct) opt.classList.add('correct');
        if (i === index && i !== q.correct) opt.classList.add('wrong');
    });
    
    const isCorrect = index === q.correct;
    currentTest.answers.push({ questionIndex: currentTest.questionIndex, correct: isCorrect });
    
    const feedback = document.getElementById('testFeedback');
    document.getElementById('feedbackTitle').textContent = isCorrect ? '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!' : '‚ùå –û—à–∏–±–∫–∞';
    document.getElementById('feedbackText').textContent = q.explanation;
    feedback.classList.add('show');
    
    document.getElementById('testNext').style.display = 'block';
}

document.getElementById('testNext').addEventListener('click', () => {
    currentTest.questionIndex++;
    showTestQuestion();
});

function finishTest() {
    const questions = appData.questions[currentTest.block] || [];
    const correct = currentTest.answers.filter(a => a.correct).length;
    const total = questions.length;
    const score = Math.round((correct / total) * 100);
    const passed = score >= 80;
    
    userProgress.testScores[`chapter_${currentTest.block}`] = correct;
    
    if (!userProgress.testHistory[`chapter_${currentTest.block}`]) {
        userProgress.testHistory[`chapter_${currentTest.block}`] = [];
    }
    userProgress.testHistory[`chapter_${currentTest.block}`].push({
        timestamp: new Date().toISOString(),
        score: correct,
        total,
        passed
    });
    
    if (passed) {
        if (!userProgress.passedBlocks.includes(`chapter_${currentTest.block}`)) {
            userProgress.passedBlocks.push(`chapter_${currentTest.block}`);
        }
        if (currentTest.block === userProgress.currentBlock && currentTest.block < 4) {
            userProgress.currentBlock++;
        }
    }
    
    saveProgress();
    updateProgressUI();
    
    document.getElementById('testView').classList.remove('active');
    
    const resultMsg = passed 
        ? `üéâ –ë–ª–æ–∫ ${currentTest.block} –ø—Ä–æ–π–¥–µ–Ω! ${correct}/${total}`
        : `‚ùå –ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ. –ù—É–∂–Ω–æ 80%. –†–µ–∑—É–ª—å—Ç–∞—Ç: ${correct}/${total}`;
    
    tg.showAlert(resultMsg);
}

document.getElementById('testBack').addEventListener('click', () => {
    document.getElementById('testView').classList.remove('active');
});

document.querySelectorAll('.ref-card').forEach(card => {
    card.addEventListener('click', () => {
        currentRefType = card.dataset.type;
        document.getElementById('refResultsTitle').innerHTML = `<i class="fas fa-list"></i> ${card.querySelector('.ref-title').textContent}`;
        renderReferences();
    });
});

document.getElementById('refSearch').addEventListener('input', (e) => {
    renderReferences(e.target.value);
});

const themeBtn = document.getElementById('themeToggle');
themeBtn.addEventListener('click', () => {
    const body = document.body;
    const isDark = body.getAttribute('data-theme') === 'dark';
    const icon = themeBtn.querySelector('i');
    if (isDark) {
        body.removeAttribute('data-theme');
        icon.className = 'fas fa-moon';
    } else {
        body.setAttribute('data-theme', 'dark');
        icon.className = 'fas fa-sun';
    }
});

document.getElementById('resetProgress').addEventListener('click', () => {
    tg.showConfirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?', (confirmed) => {
        if (confirmed) {
            userProgress = {
                currentBlock: 1, currentStep: 'text', textIndex: 0,
                testScores: {}, passedBlocks: [], blocksLocked: {}, testHistory: {}
            };
            saveProgress();
            updateProgressUI();
            tg.showAlert('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω!');
        }
    });
});

async function init() {
    loadProgress();
    
    try {
        await loadAllData();
    } catch (e) {
        console.error('Init error:', e);
        appData = JSON.parse(JSON.stringify(FALLBACK_DATA));
    }
    
    updateProgressUI();
    renderReferences();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –µ—Å–ª–∏ –≤—Å–µ –±–ª–æ–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
    if (userProgress.passedBlocks.length === 4) {
        document.getElementById('certificateContainer').innerHTML = generateCertificate();
        startConfetti();
    }
    
    setTimeout(() => {
        document.getElementById('loading').classList.add('hidden');
    }, 500);
}

init();
</script>
</body>
</html>
